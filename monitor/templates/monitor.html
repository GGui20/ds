<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepSeek AI 交易机器人 - 增强监控面板</title>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.8;
        }
        
        /* 导航标签 */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            backdrop-filter: blur(10px);
        }
        
        .nav-tab {
            padding: 12px 24px;
            border: none;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }
        
        .nav-tab.active {
            background: rgba(102, 126, 234, 0.5);
            font-weight: 600;
        }
        
        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* 卡片样式 */
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .card-time {
            font-size: 0.8em;
            opacity: 0.7;
        }
        
        /* 状态标签 */
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .status-running {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }
        
        .status-stopped {
            background: rgba(234, 88, 12, 0.2);
            color: #ea580c;
        }
        
        .status-test {
            background: rgba(249, 202, 20, 0.2);
            color: #f9ca14;
        }
        
        /* 信号样式 */
        .signal-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .signal-buy {
            background: rgba(46, 213, 115, 0.3);
            color: #2ed573;
            border: 2px solid #2ed573;
        }
        
        .signal-sell {
            background: rgba(234, 88, 12, 0.3);
            color: #ea580c;
            border: 2px solid #ea580c;
        }
        
        .signal-hold {
            background: rgba(249, 202, 20, 0.3);
            color: #f9ca14;
            border: 2px solid #f9ca14;
        }
        
        /* 数据显示 */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .data-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 10px;
        }
        
        .data-label {
            font-size: 0.85em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .data-value {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        /* 配置表单 */
        .config-form {
            display: grid;
            gap: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .form-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            color: #fff;
            font-size: 1em;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: rgba(102, 126, 234, 0.3);
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-primary:hover {
            background: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: rgba(46, 213, 115, 0.3);
            color: #2ed573;
            border: 2px solid #2ed573;
        }
        
        .btn-success:hover {
            background: rgba(46, 213, 115, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: rgba(249, 202, 20, 0.3);
            color: #f9ca14;
            border: 2px solid #f9ca14;
        }
        
        .btn-warning:hover {
            background: rgba(249, 202, 20, 0.5);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border: 2px solid #ef4444;
        }
        
        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.5);
            transform: translateY(-2px);
        }
        
        /* 表格样式 */
        .table-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* 加载状态 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            font-size: 1.2em;
            opacity: 0.7;
        }
        
        /* 错误消息 */
        .error-message {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ef4444;
        }
        
        .success-message {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #2ed573;
        }
        
        /* 进度条 */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DeepSeek AI 交易机器人</h1>
            <p class="subtitle">增强监控面板 - 参数修改 | 模式切换 | 日志查看 | Token监控</p>
        </header>
        
        <!-- 导航标签 -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('dashboard')">仪表盘</button>
            <button class="nav-tab" onclick="switchTab('config')">参数配置</button>
            <button class="nav-tab" onclick="switchTab('token')">Token监控</button>
            <button class="nav-tab" onclick="switchTab('logs')">日志查看</button>
            <button class="nav-tab" onclick="switchTab('trades')">交易记录</button>
            <button class="nav-tab" onclick="switchTab('system')">系统管理</button>
        </div>
        
        <!-- 仪表盘标签页 -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="card-grid">
                <!-- 系统状态卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">系统状态</h3>
                        <span class="card-time" id="last-update">--</span>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">运行状态</div>
                            <div class="data-value">
                                <span class="status-badge status-running" id="system-status">运行中</span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">交易模式</div>
                            <div class="data-value">
                                <span class="status-badge status-test" id="trading-mode">测试模式</span>
                            </div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">当前价格</div>
                            <div class="data-value" id="current-price">--</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">运行时长</div>
                            <div class="data-value" id="uptime">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- 交易信号卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">交易信号</h3>
                        <span class="card-time" id="signal-time">--</span>
                    </div>
                    <div style="text-align: center; padding: 10px 0;">
                        <span class="signal-badge signal-hold" id="current-signal">HOLD</span>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-top: 10px;" id="signal-reason">加载中...</div>
                </div>
                
                <!-- Token使用量卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Token使用量</h3>
                        <span class="card-time" id="token-time">--</span>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">今日使用</div>
                            <div class="data-value" id="token-today">--</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">本月使用</div>
                            <div class="data-value" id="token-month">--</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">总使用量</div>
                            <div class="data-value" id="token-total">--</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">预估成本</div>
                            <div class="data-value" id="token-cost">--</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="token-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- 日志统计卡片 -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">日志统计</h3>
                        <span class="card-time" id="log-time">--</span>
                    </div>
                    <div class="data-grid">
                        <div class="data-item">
                            <div class="data-label">今日日志</div>
                            <div class="data-value" id="log-today">--</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">错误日志</div>
                            <div class="data-value" id="log-errors">--</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">总日志数</div>
                            <div class="data-value" id="log-total">--</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">磁盘使用</div>
                            <div class="data-value" id="log-disk">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 参数配置标签页 -->
        <div id="config-tab" class="tab-content" style="display: none;">
            <div class="table-container">
                <h3>交易参数配置</h3>
                <div id="config-form">
                    <div class="loading">加载配置中...</div>
                </div>
                <button class="btn btn-primary" onclick="saveConfig()" style="margin-top: 20px;">保存配置</button>
                <div id="config-message"></div>
            </div>
            
            <div class="table-container">
                <h3>交易模式切换</h3>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">当前模式</div>
                        <div class="data-value" id="current-mode">--</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">API密钥状态</div>
                        <div class="data-value" id="api-status">--</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn btn-warning" onclick="switchMode('test')">切换到测试模式</button>
                    <button class="btn btn-success" onclick="switchMode('production')" style="margin-left: 10px;">切换到生产模式</button>
                </div>
                <div id="mode-message"></div>
            </div>
        </div>
        
        <!-- Token监控标签页 -->
        <div id="token-tab" class="tab-content" style="display: none;">
            <div class="table-container">
                <h3>Token使用量详情</h3>
                <div id="token-details">
                    <div class="loading">加载Token数据中...</div>
                </div>
            </div>
        </div>
        
        <!-- 日志查看标签页 -->
        <div id="logs-tab" class="tab-content" style="display: none;">
            <div class="table-container">
                <h3>系统日志</h3>
                <div style="margin-bottom: 15px;">
                    <select id="log-type" class="form-input" style="width: 200px; margin-right: 10px;">
                        <option value="">所有类型</option>
                        <option value="info">信息</option>
                        <option value="error">错误</option>
                        <option value="warning">警告</option>
                    </select>
                    <input type="number" id="log-limit" class="form-input" value="100" style="width: 100px; margin-right: 10px;">
                    <button class="btn btn-primary" onclick="loadLogs()">刷新日志</button>
                    <button class="btn btn-danger" onclick="cleanupLogs()" style="margin-left: 10px;">清理旧日志</button>
                </div>
                <div id="logs-content">
                    <div class="loading">加载日志中...</div>
                </div>
            </div>
        </div>
        
        <!-- 交易记录标签页 -->
        <div id="trades-tab" class="tab-content" style="display: none;">
            <div class="table-container">
                <h3>交易历史记录</h3>
                <div style="margin-bottom: 15px;">
                    <input type="number" id="trade-limit" class="form-input" value="50" style="width: 100px; margin-right: 10px;">
                    <button class="btn btn-primary" onclick="loadTrades()">刷新记录</button>
                </div>
                <div id="trades-content">
                    <div class="loading">加载交易记录中...</div>
                </div>
            </div>
        </div>
        
        <!-- 系统管理标签页 -->
        <div id="system-tab" class="tab-content" style="display: none;">
            <div class="table-container">
                <h3>系统信息</h3>
                <div id="system-info">
                    <div class="loading">加载系统信息中...</div>
                </div>
            </div>
            
            <div class="table-container">
                <h3>数据管理</h3>
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">数据文件大小</div>
                        <div class="data-value" id="data-size">--</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">交易记录数</div>
                        <div class="data-value" id="trade-count">--</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">配置参数数</div>
                        <div class="data-value" id="config-count">--</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Token记录数</div>
                        <div class="data-value" id="token-count">--</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <input type="number" id="cleanup-days" class="form-input" value="30" style="width: 100px; margin-right: 10px;">
                    <button class="btn btn-warning" onclick="cleanupData()">清理旧数据</button>
                </div>
                <div id="cleanup-message"></div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentTab = 'dashboard';
        let autoRefresh = true;
        let refreshInterval = null;
        
        // 标签页切换
        function switchTab(tabName) {
            // 隐藏所有标签页
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // 移除所有标签的active类
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // 添加active类到选中的标签
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.textContent.toLowerCase().includes(tabName)) {
                    tab.classList.add('active');
                }
            });
            
            currentTab = tabName;
            
            // 根据标签页加载相应数据
            switch(tabName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'config':
                    loadConfig();
                    break;
                case 'token':
                    loadTokenDetails();
                    break;
                case 'logs':
                    loadLogs();
                    break;
                case 'trades':
                    loadTrades();
                    break;
                case 'system':
                    loadSystemInfo();
                    break;
            }
        }
        
        // 加载仪表盘数据
        async function loadDashboard() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateDashboard(data.data);
                }
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
            }
        }
        
        // 更新仪表盘显示
        function updateDashboard(data) {
            // 更新系统状态
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            document.getElementById('system-status').textContent = data.running ? '运行中' : '已停止';
            document.getElementById('system-status').className = data.running ? 'status-badge status-running' : 'status-badge status-stopped';
            
            // 更新交易模式
            const mode = data.config?.trading_mode || 'test';
            document.getElementById('trading-mode').textContent = mode === 'production' ? '生产模式' : '测试模式';
            document.getElementById('trading-mode').className = mode === 'production' ? 'status-badge status-running' : 'status-badge status-test';
            
            // 更新价格信息
            document.getElementById('current-price').textContent = data.current_price ? `$${data.current_price}` : '--';
            
            // 更新运行时长
            document.getElementById('uptime').textContent = data.system_info?.uptime || '--';
            
            // 更新交易信号
            if (data.signals && data.signals.length > 0) {
                const latestSignal = data.signals[data.signals.length - 1];
                document.getElementById('current-signal').textContent = latestSignal.action.toUpperCase();
                document.getElementById('current-signal').className = `signal-badge signal-${latestSignal.action.toLowerCase()}`;
                document.getElementById('signal-reason').textContent = latestSignal.reason || '无具体原因';
                document.getElementById('signal-time').textContent = new Date(latestSignal.timestamp).toLocaleTimeString();
            }
            
            // 更新Token使用量
            const tokenUsage = data.token_usage || {};
            document.getElementById('token-today').textContent = tokenUsage.today || '--';
            document.getElementById('token-month').textContent = tokenUsage.month || '--';
            document.getElementById('token-total').textContent = tokenUsage.total || '--';
            document.getElementById('token-cost').textContent = tokenUsage.cost ? `$${tokenUsage.cost}` : '--';
            
            // 更新Token进度条
            const usagePercent = tokenUsage.usage_percent || 0;
            document.getElementById('token-progress').style.width = `${usagePercent}%`;
            document.getElementById('token-time').textContent = new Date().toLocaleTimeString();
            
            // 更新日志统计
            const logStats = data.log_stats || {};
            document.getElementById('log-today').textContent = logStats.today || '--';
            document.getElementById('log-errors').textContent = logStats.errors || '--';
            document.getElementById('log-total').textContent = logStats.total || '--';
            document.getElementById('log-disk').textContent = logStats.disk_usage || '--';
            document.getElementById('log-time').textContent = new Date().toLocaleTimeString();
        }
        
        // 加载配置数据
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const data = await response.json();
                
                if (data.success) {
                    renderConfigForm(data.config);
                }
            } catch (error) {
                console.error('加载配置数据失败:', error);
            }
        }
        
        // 渲染配置表单
        function renderConfigForm(config) {
            const formHtml = `
                <div class="config-form">
                    <div class="form-group">
                        <label class="form-label">交易对</label>
                        <input type="text" class="form-input" id="config-symbol" value="${config.symbol || 'BTC/USDT'}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">交易金额</label>
                        <input type="number" class="form-input" id="config-amount" value="${config.amount || 100}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">止损比例 (%)</label>
                        <input type="number" class="form-input" id="config-stop_loss" value="${config.stop_loss || 2}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">止盈比例 (%)</label>
                        <input type="number" class="form-input" id="config-take_profit" value="${config.take_profit || 5}" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">AI分析间隔 (秒)</label>
                        <input type="number" class="form-input" id="config-analysis_interval" value="${config.analysis_interval || 60}">
                    </div>
                </div>
            `;
            
            document.getElementById('config-form').innerHTML = formHtml;
            
            // 更新当前模式显示
            document.getElementById('current-mode').textContent = config.trading_mode === 'production' ? '生产模式' : '测试模式';
            document.getElementById('api-status').textContent = config.api_key ? '已配置' : '未配置';
        }
        
        // 保存配置
        async function saveConfig() {
            const configUpdates = {
                symbol: document.getElementById('config-symbol').value,
                amount: parseFloat(document.getElementById('config-amount').value),
                stop_loss: parseFloat(document.getElementById('config-stop_loss').value),
                take_profit: parseFloat(document.getElementById('config-take_profit').value),
                analysis_interval: parseInt(document.getElementById('config-analysis_interval').value)
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configUpdates)
                });
                
                const result = await response.json();
                
                const messageDiv = document.getElementById('config-message');
                if (result.success) {
                    messageDiv.innerHTML = '<div class="success-message">配置保存成功</div>';
                } else {
                    messageDiv.innerHTML = `<div class="error-message">配置保存失败: ${result.message}</div>`;
                }
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('保存配置失败:', error);
                document.getElementById('config-message').innerHTML = '<div class="error-message">保存配置失败</div>';
            }
        }
        
        // 切换交易模式
        async function switchMode(mode) {
            try {
                const response = await fetch('/api/switch_mode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ mode: mode })
                });
                
                const result = await response.json();
                
                const messageDiv = document.getElementById('mode-message');
                if (result.success) {
                    messageDiv.innerHTML = `<div class="success-message">已成功切换到${mode === 'production' ? '生产模式' : '测试模式'}</div>`;
                    loadConfig(); // 重新加载配置显示
                } else {
                    messageDiv.innerHTML = `<div class="error-message">模式切换失败: ${result.message}</div>`;
                }
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('切换模式失败:', error);
                document.getElementById('mode-message').innerHTML = '<div class="error-message">切换模式失败</div>';
            }
        }
        
        // 加载Token详情
        async function loadTokenDetails() {
            try {
                const response = await fetch('/api/token_usage');
                const data = await response.json();
                
                if (data.success) {
                    renderTokenDetails(data.data);
                }
            } catch (error) {
                console.error('加载Token详情失败:', error);
            }
        }
        
        // 渲染Token详情
        function renderTokenDetails(tokenData) {
            const html = `
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">今日使用量</div>
                        <div class="data-value">${tokenData.today || 0}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">本月使用量</div>
                        <div class="data-value">${tokenData.month || 0}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">总使用量</div>
                        <div class="data-value">${tokenData.total || 0}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">预估成本</div>
                        <div class="data-value">$${tokenData.cost || 0}</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>使用趋势</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${tokenData.usage_percent || 0}%"></div>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">
                        使用率: ${tokenData.usage_percent || 0}%
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>详细记录</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>模型</th>
                                <th>输入Token</th>
                                <th>输出Token</th>
                                <th>总Token</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tokenData.details ? tokenData.details.slice(-10).map(record => `
                                <tr>
                                    <td>${new Date(record.timestamp).toLocaleString()}</td>
                                    <td>${record.model || 'N/A'}</td>
                                    <td>${record.input_tokens || 0}</td>
                                    <td>${record.output_tokens || 0}</td>
                                    <td>${record.total_tokens || 0}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="5">暂无详细记录</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('token-details').innerHTML = html;
        }
        
        // 加载日志
        async function loadLogs() {
            const logType = document.getElementById('log-type').value;
            const limit = document.getElementById('log-limit').value;
            
            try {
                const response = await fetch(`/api/logs?type=${logType}&limit=${limit}`);
                const data = await response.json();
                
                if (data.success) {
                    renderLogs(data.logs);
                }
            } catch (error) {
                console.error('加载日志失败:', error);
            }
        }
        
        // 渲染日志
        function renderLogs(logs) {
            if (!logs || logs.length === 0) {
                document.getElementById('logs-content').innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">暂无日志记录</div>';
                return;
            }
            
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>级别</th>
                            <th>模块</th>
                            <th>消息</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => `
                            <tr>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                                <td>
                                    <span class="status-badge ${getLogLevelClass(log.level)}">${log.level}</span>
                                </td>
                                <td>${log.module || 'N/A'}</td>
                                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${log.message || 'N/A'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('logs-content').innerHTML = html;
        }
        
        // 获取日志级别样式类
        function getLogLevelClass(level) {
            switch (level.toLowerCase()) {
                case 'error': return 'status-stopped';
                case 'warning': return 'status-test';
                case 'info': return 'status-running';
                default: return 'status-running';
            }
        }
        
        // 清理日志
        async function cleanupLogs() {
            if (!confirm('确定要清理30天前的旧日志吗？此操作不可恢复。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/cleanup_logs', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('日志清理成功');
                    loadLogs(); // 重新加载日志
                } else {
                    alert('日志清理失败: ' + result.message);
                }
            } catch (error) {
                console.error('清理日志失败:', error);
                alert('清理日志失败');
            }
        }
        
        // 加载交易记录
        async function loadTrades() {
            const limit = document.getElementById('trade-limit').value;
            
            try {
                const response = await fetch(`/api/trades?limit=${limit}`);
                const data = await response.json();
                
                if (data.success) {
                    renderTrades(data.trades);
                }
            } catch (error) {
                console.error('加载交易记录失败:', error);
            }
        }
        
        // 渲染交易记录
        function renderTrades(trades) {
            if (!trades || trades.length === 0) {
                document.getElementById('trades-content').innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">暂无交易记录</div>';
                return;
            }
            
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>交易对</th>
                            <th>方向</th>
                            <th>数量</th>
                            <th>价格</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${trades.map(trade => `
                            <tr>
                                <td>${new Date(trade.timestamp).toLocaleString()}</td>
                                <td>${trade.symbol || 'N/A'}</td>
                                <td>
                                    <span class="signal-badge ${trade.side === 'BUY' ? 'signal-buy' : 'signal-sell'}">${trade.side === 'BUY' ? '买入' : '卖出'}</span>
                                </td>
                                <td>${trade.amount || 0}</td>
                                <td>$${trade.price || 0}</td>
                                <td>
                                    <span class="status-badge ${trade.status === 'filled' ? 'status-running' : 'status-test'}">${trade.status === 'filled' ? '已完成' : '进行中'}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('trades-content').innerHTML = html;
        }
        
        // 加载系统信息
        async function loadSystemInfo() {
            try {
                const response = await fetch('/api/system_info');
                const data = await response.json();
                
                if (data.success) {
                    renderSystemInfo(data.system_info);
                }
            } catch (error) {
                console.error('加载系统信息失败:', error);
            }
        }
        
        // 渲染系统信息
        function renderSystemInfo(systemInfo) {
            const html = `
                <div class="data-grid">
                    <div class="data-item">
                        <div class="data-label">系统版本</div>
                        <div class="data-value">${systemInfo.version || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">运行时长</div>
                        <div class="data-value">${systemInfo.uptime || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">内存使用</div>
                        <div class="data-value">${systemInfo.memory_usage || 'N/A'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">CPU使用率</div>
                        <div class="data-value">${systemInfo.cpu_usage || 'N/A'}</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>磁盘使用情况</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${systemInfo.disk_usage_percent || 0}%"></div>
                    </div>
                    <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">
                        使用率: ${systemInfo.disk_usage_percent || 0}%
                    </div>
                </div>
            `;
            
            document.getElementById('system-info').innerHTML = html;
            
            // 更新数据统计
            document.getElementById('data-size').textContent = systemInfo.data_file_size || '--';
            document.getElementById('trade-count').textContent = systemInfo.trade_count || '--';
            document.getElementById('config-count').textContent = systemInfo.config_count || '--';
            document.getElementById('token-count').textContent = systemInfo.token_record_count || '--';
        }
        
        // 清理数据
        async function cleanupData() {
            const days = document.getElementById('cleanup-days').value;
            
            if (!confirm(`确定要清理${days}天前的旧数据吗？此操作不可恢复。`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/cleanup_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ days: parseInt(days) })
                });
                
                const result = await response.json();
                
                const messageDiv = document.getElementById('cleanup-message');
                if (result.success) {
                    messageDiv.innerHTML = '<div class="success-message">数据清理成功</div>';
                    loadSystemInfo(); // 重新加载系统信息
                } else {
                    messageDiv.innerHTML = `<div class="error-message">数据清理失败: ${result.message}</div>`;
                }
                
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
                
            } catch (error) {
                console.error('清理数据失败:', error);
                document.getElementById('cleanup-message').innerHTML = '<div class="error-message">清理数据失败</div>';
            }
        }
        
        // 自动刷新功能
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                if (currentTab === 'dashboard') {
                    loadDashboard();
                }
            }, 5000); // 每5秒刷新一次
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            // 加载初始数据
            loadDashboard();
            
            // 启动自动刷新
            startAutoRefresh();
            
            // 添加键盘快捷键
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey) {
                    switch(e.key) {
                        case '1':
                            e.preventDefault();
                            switchTab('dashboard');
                            break;
                        case '2':
                            e.preventDefault();
                            switchTab('config');
                            break;
                        case '3':
                            e.preventDefault();
                            switchTab('token');
                            break;
                        case '4':
                            e.preventDefault();
                            switchTab('logs');
                            break;
                        case '5':
                            e.preventDefault();
                            switchTab('trades');
                            break;
                        case '6':
                            e.preventDefault();
                            switchTab('system');
                            break;
                        case 'r':
                            e.preventDefault();
                            if (currentTab === 'dashboard') {
                                loadDashboard();
                            }
                            break;
                    }
                }
            });
        };
        
        // 页面卸载时清理定时器
        window.onbeforeunload = function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        };
    </script>
</body>
</html>